name: Azure ML Pipeline Setup

on:
  workflow_dispatch:
  push:
    branches:
      - main

env:
  GROUP: mlops-project
  WORKSPACE: sadiksha-sapkota-ml
  LOCATION: westeurope
  COMPUTE_NAME: cli-created-machine-v2

jobs:
  setup-compute:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Azure -- Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Install Azure CLI + ML extension
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
          az extension add --name ml -y
          az configure --defaults group=$GROUP workspace=$WORKSPACE location=$LOCATION

      - name: Azure -- Create compute if not exists
        run: |
          echo "Checking if compute '$COMPUTE_NAME' exists..."
          if ! az ml compute show --name $COMPUTE_NAME > /dev/null 2>&1; then
            echo "Compute not found — creating..."
            az ml compute create --file ./environment/compute.yaml
          else
            echo "✅ Compute already exists. Skipping creation."
          fi

      - name: Azure -- Start compute if not running
        run: |
          echo "Checking compute status..."
          STATUS=$(az ml compute show --name $COMPUTE_NAME --query "status.state" -o tsv)
          echo "Current status: $STATUS"
          if [[ "$STATUS" != "Running" ]]; then
            echo "Compute is not running. Starting it..."
            az ml compute start --name $COMPUTE_NAME
          else
            echo "✅ Compute is already running. No action needed."
          fi
